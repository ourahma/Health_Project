{% extends 'pages/base.html' %}
{% load static %}
{% block content %}

<div class="content-wrapper">
  <div class="row">
    <div class="col-md-12 grid-margin">
      <div class="row">
        <div class="col-12 col-xl-8 mb-4 mb-xl-0">
          
          {% if request.user.is_medcin %}
          <h3 class="font-weight-bold">Bonjour Dr. {{ request.user.nom }}</h3>
          {% else %}
          <h3 class="font-weight-bold">Bonjour  {{ request.user.nom }}</h3>
          {% endif %}
            
          
          <h6 class="font-weight-normal mb-0">
            Simplifiez la gestion de votre cabinet médical
          </h6>
        </div>
        
      </div>
    </div>
  </div>
  <div class="row">
   
    <div class="col-md-12 grid-margin transparent">
      <div class="row">
        <div class="col-md-4 mb-4 stretch-card transparent">
          <div class="card card-tale">
            <div class="card-body">
              <p class="mb-4">Les rendez-vous planifiés pour aujourd'hui</p>
              <p class="fs-30 mb-2">{{ rendez_vous_today_count|default:0 }}</p>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-4 stretch-card transparent">
          <div class="card card-dark-blue">
            <div class="card-body">
              <p class="mb-4">Le revenus de mois</p>
              <p class="fs-30 mb-2">{{ revenu_month|default:0 }} MAD</p>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-4 stretch-card transparent">
          <div class="card card-dark-blue">
            <div class="card-body">
              <p class="mb-4">Le revenus d'ajourd'hui</p>
              <p class="fs-30 mb-2"> {{ revenu_today|default:0 }} MAD</p>
              
            </div>
          </div>
        </div>
      </div>
   
    </div>
  </div>
 
  <div class="row">
    <div class="col-md-12 grid-margin transparent">
      <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Les nombres des rendez-vous dans les dernieres 6 mois</h4>
              <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">L'évolution des montant dans les derniers 6 mois</h4>
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">La distribution des status des rendez vous</h4>
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Les top patient payant des les derniere 6 mois.</h4>
              <canvas id="doughnutChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Répartition des patients diabétiques</h4>
              <canvas id="diabetesPieChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">L'évolution de nombre de prédiction par résultat</h4>
              <canvas id="evolutionDiabeteChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <!-- Répartition des maladies prédites (Pie Chart) -->
        <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Répartition des maladies prédites</h4>
                    <canvas id="maladiesPieChart"></canvas>
                </div>
            </div>
        </div>
    
        <!-- Évolution des maladies prédites (Line Chart) -->
        <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Évolution des prédictions de maladies</h4>
                    <canvas id="maladiesLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Fetch data for the line chart (Rendez-vous over 6 months)
    fetch('/generate-plots/')
      .then(response => response.json())
      .then(data => {
        const ctxLine = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: data.months,
            datasets: [{
              label: 'Rendez-vous',
              data: data.rendezvous_counts,
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1,
              fill: false
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });

    // Fetch data for the bar chart (Montant over 6 months)
    fetch('/generate-plots/')
      .then(response => response.json())
      .then(data => {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: data.months,
            datasets: [{
              label: 'Montant (MAD)',
              data: data.montant_totals,
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              borderColor: 'rgba(153, 102, 255, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });

    // Fetch data for the pie chart (Rendez-vous Status Distribution)
    fetch('/rdv-status-distribution/')
      .then(response => response.json())
      .then(data => {
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: data.labels,
            datasets: [{
              data: data.data,
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
              ],
              borderWidth: 1
            }]
          }
        });
      });
      // Fetch data for the diabetes pie chart
    fetch('/statistiques-diabete/')
    .then(response => response.json())
    .then(data => {
      const ctxDiabetes = document.getElementById('diabetesPieChart').getContext('2d');
      new Chart(ctxDiabetes, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.data,
            backgroundColor: ['#ff6384', '#36a2eb'],
            borderColor: ['#ff6384', '#36a2eb'],
            borderWidth: 1
          }]
        }
      });
    });

    // Fetch data for the doughnut chart (Top 3 Patients by Montant in Last 6 Months)
    fetch('/montant-by-patient/')
      .then(response => response.json())
      .then(data => {
        const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
        const doughnutChart = new Chart(ctxDoughnut, {
          type: 'doughnut',
          data: {
            labels: data.labels,  // Noms des 3 patients
            datasets: [{
              data: data.total_montants,  // Montants totaux des 3 patients
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
              ],
              borderWidth: 1
            }]
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: 'Top 3 Patients par Montant Dépensé (6 derniers mois)'
              }
            }
          }
        });
      });
      fetch("{% url 'evolution_statistiques_diabete' %}")  // Mets le bon nom de ta vue ici
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('evolutionDiabeteChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,  // Mois
                    datasets: [
                        {
                            label: "Diabète détecté",
                            data: data.positive_counts,
                            borderColor: "red",
                            backgroundColor: "rgba(255, 0, 0, 0.2)",
                            fill: true
                        },
                        {
                            label: "Pas de diabète",
                            data: data.negative_counts,
                            borderColor: "green",
                            backgroundColor: "rgba(0, 255, 0, 0.2)",
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function() {
      fetch("{% url 'statistiques_maladies' %}")  // Mets le bon nom de la vue
          .then(response => response.json())
          .then(data => {
             
              const ctxPie = document.getElementById('maladiesPieChart').getContext('2d');
              new Chart(ctxPie, {
                  type: 'pie',
                  data: {
                      labels: data.labels_pie,
                      datasets: [{
                          data: data.data_pie,
                          backgroundColor: ['#93ff7a', '#29285f', '#ffcd56', '#4bc0c0'],
                          borderColor: ['#1e1e1e', '#8dd968', '#b18393', '#4bc0c0'],
                          borderWidth: 1
                      }]
                  }
              });

              
              const ctxLine = document.getElementById('maladiesLineChart').getContext('2d');
              new Chart(ctxLine, {
                  type: 'line',
                  data: {
                      labels: data.labels_line,
                      datasets: Object.keys(data.evolution_data).map(maladie => ({
                          label: maladie,
                          data: data.evolution_data[maladie],
                          borderColor: "#" + Math.floor(Math.random()*16777215).toString(16),
                          backgroundColor: "rgba(10, 231, 21, 0.2)",
                          fill: true
                      }))
                  },
                  options: {
                      responsive: true,
                      scales: {
                          y: {
                              beginAtZero: true
                          }
                      }
                  }
              });
          });
  });
</script>

{% endblock content %}